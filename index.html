<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySync | Track, Achieve, Inspire</title>
    <style>
        /* Basic Reset and Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            color: #333;
        }
        header {
            background-color: #4a90e2;
            color: white;
            padding: 20px 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 2px;
        }
        header h2 {
            margin-top: 8px;
            font-weight: 300;
            font-style: italic;
            font-size: 1.2rem;
            opacity: 0.85;
        }
        
        /* Auth Bar Styles */
        #auth-bar {
            text-align: center;
            padding: 12px;
            background: linear-gradient(90deg, #ffe4b5, #f0f8ff);
            border-bottom: 1px solid #ddd;
            font-size: 0.95rem;
        }
        #auth-bar button {
            margin: 0 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        #user-info {
            color: #2c5aa0;
            font-weight: 500;
        }
        
        nav {
            display: flex;
            justify-content: center;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        nav a {
            padding: 15px 20px;
            display: block;
            color: #4a90e2;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.3s ease, color 0.3s ease;
        }
        nav a:hover, nav a.active {
            background: #4a90e2;
            color: white;
        }
        main {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 15px 50px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(74,144,226,0.15);
        }
        section {
            display: none;
            padding: 20px;
        }
        section.active {
            display: block;
        }
        h3 {
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 6px;
            margin-bottom: 16px;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #4a90e2;
            color: white;
        }
        /* Progress bar styles */
        .progress-bar {
            background-color: #ddd;
            border-radius: 20px;
            overflow: hidden;
            height: 18px;
            width: 100%;
            margin-top: 5px;
        }
        .progress-fill {
            display: block;
            height: 100%;
            background-color: #4a90e2;
            width: 0;
            transition: width 1s ease-in-out;
            border-radius: 20px;
        }
        /* Form styles */
        form {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        input[type=text], textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #357ABD;
        }
        /* List and checkpoints */
        ul { list-style-type: none; padding-left: 0; }
        .checklist li {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .checklist li:last-child { border-bottom: none; }
        .checklist input[type=checkbox] {
            margin-right: 12px;
            transform: scale(1.3);
            cursor: pointer;
        }
        /* Quote styles */
        #quote {
            font-style: italic;
            font-weight: 400;
            color: #10316b;
            margin: 15px 0 25px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        /* Stats and Analytics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 20px 0;
        }
        
        #streak-counter {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a90e2;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(74,144,226,0.2);
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        canvas {
            max-width: 100%;
            height: 300px !important;
        }
        
        #weekly-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border-left: 4px solid #4a90e2;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Loading and offline states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .offline-notice {
            background: #ffebee;
            color: #c62828;
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Responsive tweaks */
        @media(max-width: 600px) {
            nav {
                flex-wrap: wrap;
            }
            nav a {
                flex: 1 0 33.33%;
                text-align: center;
                padding: 12px 8px;
                font-size: 0.9rem;
            }
            main {
                margin: 10px;
            }
            header h1 {
                font-size: 2rem;
            }
            #streak-counter {
                font-size: 2rem;
                padding: 20px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Welcome to StudySync!</h1>
        <h2 id="quote">"Success is the sum of small efforts, repeated day in and day out."</h2>
    </header>
    
    <!-- Authentication Bar -->
    <div id="auth-bar">
        <button id="login-btn">üîê Sign in with Google</button>
        <span id="user-info" style="display:none;">
            Welcome back, <strong id="user-name"></strong>! 
            <button id="logout-btn">Log out</button>
        </span>
        <div id="offline-notice" class="offline-notice" style="display:none;">
            üì∂ Offline mode - Data will sync when connection returns
        </div>
    </div>
    
    <nav>
        <a href="#" class="active" data-section="home">Home</a>
        <a href="#" data-section="dashboard">Dashboard</a>
        <a href="#" data-section="goals">Goals</a>
        <a href="#" data-section="journal">Journal</a>
        <a href="#" data-section="stats">Stats</a>
        <a href="#" data-section="motivation">Motivation</a>
        <a href="#" data-section="resources">Resources</a>
    </nav>
    
    <main>
        <section id="home" class="active">
            <h3>Welcome & Motivation</h3>
            <p style="text-align:center; font-weight: 600; font-size: 1.1rem;">Unlock Your Potential. Study Smart. Achieve More.</p>
            <div style="max-width: 600px; margin: auto;">
                <h4>Weekly Progress</h4>
                <table>
                    <thead>
                        <tr><th>Subject</th><th>Progress</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Mathematics</td><td>
                            <div class="progress-bar"><span class="progress-fill" style="width: 67%;"></span></div>
                        </td></tr>
                        <tr><td>Physics</td><td>
                            <div class="progress-bar"><span class="progress-fill" style="width: 50%;"></span></div>
                        </td></tr>
                        <tr><td>Electronics</td><td>
                            <div class="progress-bar"><span class="progress-fill" style="width: 50%;"></span></div>
                        </td></tr>
                        <tr><td>Python</td><td>
                            <div class="progress-bar"><span class="progress-fill" style="width: 33%;"></span></div>
                        </td></tr>
                        <tr><td>Communication</td><td>
                            <div class="progress-bar"><span class="progress-fill" style="width: 100%;"></span></div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="dashboard">
            <h3>Study Dashboard</h3>
            <p>Track your subjects and see your progress below.</p>
            <table>
                <thead>
                    <tr><th>Subject</th><th>This Week's Target</th><th>Done</th><th>Progress</th></tr>
                </thead>
                <tbody>
                    <tr><td>Mathematics</td><td>Differentiation, Integration, Matrix Operations</td><td>2/3 topics</td><td>
                        <div class="progress-bar"><span class="progress-fill" style="width: 67%;"></span></div>
                    </td></tr>
                    <tr><td>Physics</td><td>Kinematics, Newton's Laws, Energy Conservation</td><td>1/2 topics</td><td>
                        <div class="progress-bar"><span class="progress-fill" style="width: 50%;"></span></div>
                    </td></tr>
                    <tr><td>Electronics</td><td>Ohm's Law, Circuit Analysis, Semiconductors</td><td>1/2 topics</td><td>
                        <div class="progress-bar"><span class="progress-fill" style="width: 50%;"></span></div>
                    </td></tr>
                    <tr><td>Python</td><td>Variables, Loops, Functions, Mini-project</td><td>1/3 goals</td><td>
                        <div class="progress-bar"><span class="progress-fill" style="width: 33%;"></span></div>
                    </td></tr>
                    <tr><td>Communication</td><td>Email Writing, Presentation Skills</td><td>2/2 tasks</td><td>
                        <div class="progress-bar"><span class="progress-fill" style="width: 100%;"></span></div>
                    </td></tr>
                </tbody>
            </table>
        </section>

        <section id="goals">
            <h3>Set Your Study Goals</h3>
            <form id="goal-form">
                <label for="goal-input">New Goal:</label>
                <input type="text" id="goal-input" placeholder="Enter your goal here..." required>
                <button type="submit">Add Goal</button>
            </form>
            <ul id="goal-list" class="checklist"></ul>
        </section>

        <section id="journal">
            <h3>Daily Journal & Reflection</h3>
            <form id="journal-form">
                <label for="journal-text">Write about your study day:</label>
                <textarea id="journal-text" rows="6" placeholder="What went well? What can be improved? How do you feel about your progress?"></textarea>
                <button type="submit">Save Entry</button>
            </form>
            <ul id="journal-entries"></ul>
        </section>

        <section id="stats">
            <h3>üìä Analytics & Insights</h3>
            
            <div id="streak-counter">Loading streak...</div>
            
            <div class="stats-grid">
                <div class="chart-container">
                    <h4>üéØ Goal Completion Rate</h4>
                    <canvas id="goalChart"></canvas>
                    <div style="text-align: center; margin-top: 10px;">
                        <strong>Goals This Week: <span id="goals-summary">Loading...</span></strong>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4>‚è±Ô∏è Study Hours by Subject</h4>
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
            
            <div id="weekly-summary">
                <h4>üìà Weekly Study Summary</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>Total Study Time</strong><br>
                        <span id="total-time">Loading...</span>
                    </div>
                    <div class="summary-item">
                        <strong>Goals Completed</strong><br>
                        <span id="completed-goals">Loading...</span>
                    </div>
                    <div class="summary-item">
                        <strong>Most Productive Day</strong><br>
                        <span id="best-day">Loading...</span>
                    </div>
                    <div class="summary-item">
                        <strong>Top Subject</strong><br>
                        <span id="top-subject">Loading...</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="motivation">
            <h3>Motivation Zone</h3>
            <p id="motivation-quote" style="font-style: italic; font-size: 1.2rem; color: #4a90e2; text-align: center;"></p>
            <button id="new-quote-btn" style="display: block; margin: auto; padding: 8px 16px;">Get New Quote</button>
            <ul id="quote-history" style="max-height: 200px; overflow-y: auto; margin-top: 20px;"></ul>
        </section>

        <section id="resources">
            <h3>Knowledge Hub & Resources</h3>
            <p>Access all your study materials quickly.</p>
            
            <h4>Mathematics</h4>
            <ul>
                <li><a href="https://ncert.nic.in/textbook.php" target="_blank">NCERT Class 12 Mathematics Books</a></li>
                <li><a href="https://nptel.ac.in/courses/111/106/111106094/" target="_blank">NPTEL Engineering Mathematics</a></li>
                <li><a href="https://www.youtube.com/user/gatesmashers" target="_blank">Gate Smashers YouTube</a></li>
                <li><a href="https://www.youtube.com/channel/UCB3QHZf8Brffn76_Jk88nTQ" target="_blank">Neso Academy Mathematics</a></li>
            </ul>

            <h4>Physics</h4>
            <ul>
                <li><a href="https://ncert.nic.in/textbook.php" target="_blank">NCERT Physics (11th & 12th)</a></li>
                <li><a href="https://ocw.mit.edu/courses/8-01sc-classical-mechanics-fall-2016/" target="_blank">MIT OpenCourseWare - Classical Mechanics</a></li>
                <li><a href="https://www.youtube.com/channel/UCB3QHZf8Brffn76_Jk88nTQ" target="_blank">Neso Academy Physics</a></li>
                <li><a href="https://education.sakshi.com/en/eamcet/quick-review/physics" target="_blank">Sakshi Education Physics Review</a></li>
            </ul>

            <h4>Electronics & Electrical</h4>
            <ul>
                <li><a href="#" target="_blank">Electronic Devices & Circuit Theory - Boylestad</a></li>
                <li><a href="https://www.scribd.com/document/722664013/Syllabus-of-First-Year-Basic-Electrical-and-Electronics" target="_blank">First Year Electronics Syllabus</a></li>
                <li><a href="https://www.youtube.com/channel/UCB3QHZf8Brffn76_Jk88nTQ" target="_blank">Neso Academy Electronics</a></li>
            </ul>

            <h4>Python Programming</h4>
            <ul>
                <li><a href="https://www.coursera.org/learn/python" target="_blank">Python for Everybody (Coursera)</a></li>
                <li><a href="https://www.youtube.com/watch?v=gfDE2a7MKjA" target="_blank">Python Full Course - YouTube</a></li>
                <li><a href="https://www.codecademy.com/learn/learn-python-3" target="_blank">Codecademy Python 3</a></li>
                <li><a href="https://automatetheboringstuff.com/" target="_blank">Automate the Boring Stuff with Python</a></li>
            </ul>

            <h4>Professional Communication</h4>
            <ul>
                <li><a href="https://eng.libretexts.org/Courses/California_State_Polytechnic_University_Humboldt/Engineering_Success:_A_Seminar_for_First-Year_Students/02:_Topic_02._Professional_Email_Communication_for_Engineers" target="_blank">Professional Email Communication</a></li>
                <li><a href="https://open.lib.umn.edu/technicalcommunication/" target="_blank">Technical Communication Guide</a></li>
                <li><a href="https://ocw.mit.edu/courses/writing-and-humanistic-studies/" target="_blank">MIT Technical Communication</a></li>
            </ul>
        </section>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-messaging-compat.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // --- Firebase Configuration & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyArjKxUfvehNSA-GLXuuiOpChe55c4MQDE",
            authDomain: "studysync-prod-acfc6.firebaseapp.com",
            projectId: "studysync-prod-acfc6",
            storageBucket: "studysync-prod-acfc6.firebasestorage.app",
            messagingSenderId: "372359765372",
            appId: "1:372359765372:web:bb5252996a4c98597758f9",
            measurementId: "G-3E4Z5L962V"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messaging = firebase.messaging();

        // Global variables
        let currentUser = null;
        let isOnline = navigator.onLine;
        let goalChart = null;
        let timeChart = null;

        // --- Navigation handling ---
        const navLinks = document.querySelectorAll('nav a');
        const sections = document.querySelectorAll('main section');

        navLinks.forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const target = link.getAttribute('data-section');
                
                // Remove active class from all
                navLinks.forEach(l => l.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                
                // Add active
                link.classList.add('active');
                document.getElementById(target).classList.add('active');
                
                // Load stats when stats section is opened
                if (target === 'stats' && currentUser) {
                    console.log('Loading analytics...');
                    setTimeout(async () => {
                        await renderStats();
                    }, 100);
                }
            });
        });

        // --- Authentication Logic ---
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const offlineNotice = document.getElementById('offline-notice');

        loginBtn.onclick = async () => {
            try {
                console.log('Starting login process...');
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                const result = await auth.signInWithPopup(provider);
                console.log('Login successful:', result.user.email);
            } catch (error) {
                console.error('Login error details:', error);
                
                if (error.code === 'auth/popup-closed-by-user') {
                    alert('Login cancelled. Please try again.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    alert('Domain not authorized. Please contact support.');
                } else if (error.code === 'auth/popup-blocked') {
                    alert('Popup blocked. Please allow popups and try again.');
                } else {
                    alert(`Login failed: ${error.message}`);
                }
            }
        };

        logoutBtn.onclick = () => auth.signOut();

        // Monitor online/offline status
        window.addEventListener('online', () => {
            isOnline = true;
            offlineNotice.style.display = 'none';
            if (currentUser) syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            offlineNotice.style.display = 'block';
        });

        // Auth state listener
        auth.onAuthStateChanged(async user => {
            currentUser = user;
            if (user) {
                userName.textContent = user.displayName ? user.displayName.split(' ')[0] : 'User';
                loginBtn.style.display = 'none';
                userInfo.style.display = 'inline';
                
                // Load user data
                await loadGoals();
                await loadJournal();
                
                // Set up notifications
                await setupNotifications();
            } else {
                loginBtn.style.display = 'inline';
                userInfo.style.display = 'none';
                
                // Clear data display
                document.getElementById('goal-list').innerHTML = '';
                document.getElementById('journal-entries').innerHTML = '';
            }
        });

        // --- Push Notifications Setup ---
        async function setupNotifications() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await messaging.getToken({
                        vapidKey: "BIAkTRN4KwY4b775wFL5SGsjYvlCVEVia6olhpEn2by5LKf7hohw09Q4vJvRPCq1SvLbSrFQHmnVZxgSWXxu1TU"
                    });
                    
                    if (token) {
                        console.log('FCM Token:', token);
                        await db.collection('fcmTokens').doc(currentUser.uid).set({
                            token: token,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        setTimeout(() => {
                            new Notification('StudySync Ready!', {
                                body: 'Your study tracker is set up and ready to go! üöÄ',
                                icon: '/favicon.ico'
                            });
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Notification setup error:', error);
            }
        }

        // --- FIXED ANALYTICS FUNCTIONS ---
        async function renderStats() {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }

            try {
                console.log('Loading analytics data...');
                
                // Show loading states
                document.getElementById('streak-counter').innerHTML = 'Loading streak...';
                document.getElementById('goals-summary').innerHTML = 'Loading...';
                document.getElementById('total-time').textContent = 'Loading...';
                document.getElementById('completed-goals').textContent = 'Loading...';
                document.getElementById('best-day').textContent = 'Loading...';
                document.getElementById('top-subject').textContent = 'Loading...';
                
                // Load all analytics
                await updateStreakCounter();
                await renderGoalChart();
                await renderTimeChart();
                await updateWeeklySummary();
                
                console.log('Analytics loaded successfully');
                
            } catch (error) {
                console.error('Error rendering stats:', error);
                showErrorMessage();
            }
        }

        // Calculate and display study streak
        async function updateStreakCounter() {
            try {
                const journalDoc = await db.collection('journal').doc(currentUser.uid).get();
                const entries = journalDoc.exists ? journalDoc.data().entries || [] : [];
                
                let streak = calculateStreak(entries);
                document.getElementById('streak-counter').innerHTML = `${streak} day${streak !== 1 ? 's' : ''} üî•`;
            } catch (error) {
                console.error('Error updating streak:', error);
                document.getElementById('streak-counter').innerHTML = '0 days üî•';
            }
        }

        function calculateStreak(entries) {
            if (entries.length === 0) return 0;
            
            const today = new Date();
            let streak = 0;
            let currentDate = new Date(today);
            
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toDateString();
                const hasEntry = entries.some(entry => {
                    const entryDate = new Date(entry.date || entry);
                    return entryDate.toDateString() === dateStr;
                });
                
                if (hasEntry) {
                    streak++;
                } else if (i > 0) {
                    break; // Streak broken
                }
                
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            return streak;
        }

        // Render goal completion chart
        async function renderGoalChart() {
            try {
                const goalsDoc = await db.collection('goals').doc(currentUser.uid).get();
                const goalsData = goalsDoc.exists ? goalsDoc.data().items || [] : [];
                
                const completed = goalsData.filter(g => g.completed).length;
                const pending = goalsData.length - completed;
                const total = goalsData.length;
                
                document.getElementById('goals-summary').innerHTML = `${completed}/${total}`;
                
                // Destroy existing chart
                if (goalChart) {
                    goalChart.destroy();
                }
                
                const ctx = document.getElementById('goalChart').getContext('2d');
                goalChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completed, pending || 1], // Ensure at least 1 to show chart
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error rendering goal chart:', error);
            }
        }

        // Render study hours chart
        async function renderTimeChart() {
            try {
                const subjects = ['Math', 'Physics', 'Electronics', 'Python', 'Communication'];
                
                // Try to get real data or use sample data
                const progressDoc = await db.collection('progress').doc(currentUser.uid).get();
                let hours = [4.5, 3.2, 2.8, 1.5, 2.1]; // Default sample data
                
                if (progressDoc.exists && progressDoc.data().weeklyHours) {
                    hours = progressDoc.data().weeklyHours;
                }
                
                // Destroy existing chart
                if (timeChart) {
                    timeChart.destroy();
                }
                
                const ctx = document.getElementById('timeChart').getContext('2d');
                timeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: [{
                            label: 'Hours',
                            data: hours,
                            backgroundColor: [
                                '#4a90e2',
                                '#28a745',
                                '#ffc107',
                                '#17a2b8',
                                '#6f42c1'
                            ],
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Subjects',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error rendering time chart:', error);
            }
        }

        // Update weekly summary stats
        async function updateWeeklySummary() {
            try {
                const goalsDoc = await db.collection('goals').doc(currentUser.uid).get();
                const goalsData = goalsDoc.exists ? goalsDoc.data().items || [] : [];
                const completed = goalsData.filter(g => g.completed).length;
                
                const progressDoc = await db.collection('progress').doc(currentUser.uid).get();
                const hours = progressDoc.exists && progressDoc.data().weeklyHours ? 
                              progressDoc.data().weeklyHours : [4.5, 3.2, 2.8, 1.5, 2.1];
                
                const totalTime = hours.reduce((a, b) => a + b, 0).toFixed(1);
                const subjects = ['Mathematics', 'Physics', 'Electronics', 'Python', 'Communication'];
                const topSubject = subjects[hours.indexOf(Math.max(...hours))];
                
                document.getElementById('total-time').textContent = `${totalTime} hours`;
                document.getElementById('completed-goals').textContent = `${completed}/${goalsData.length}`;
                document.getElementById('best-day').textContent = 'Wednesday';
                document.getElementById('top-subject').textContent = topSubject;
                
            } catch (error) {
                console.error('Error updating weekly summary:', error);
            }
        }

        function showErrorMessage() {
            document.getElementById('streak-counter').innerHTML = 'Error loading data';
            document.getElementById('goals-summary').innerHTML = 'Error';
            document.getElementById('total-time').textContent = 'Error';
            document.getElementById('completed-goals').textContent = 'Error';
            document.getElementById('best-day').textContent = 'Error';
            document.getElementById('top-subject').textContent = 'Error';
        }

        // --- Goals Management ---
        const goalsForm = document.getElementById('goal-form');
        const goalInput = document.getElementById('goal-input');
        const goalList = document.getElementById('goal-list');
        let goalsData = [];

        async function loadGoals() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('goals').doc(currentUser.uid).get();
                goalsData = doc.exists ? doc.data().items || [] : [];
                renderGoals();
            } catch (error) {
                console.error('Error loading goals:', error);
                goalsData = JSON.parse(localStorage.getItem('studyGoals') || '[]');
                renderGoals();
            }
        }

        async function saveGoals() {
            if (!currentUser) return;
            
            if (isOnline) {
                try {
                    await db.collection('goals').doc(currentUser.uid).set({ 
                        items: goalsData,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving goals:', error);
                    localStorage.setItem('studyGoals', JSON.stringify(goalsData));
                }
            } else {
                localStorage.setItem('studyGoals', JSON.stringify(goalsData));
                localStorage.setItem('goalsPendingSync', 'true');
            }
        }

        function renderGoals() {
            goalList.innerHTML = '';
            goalsData.forEach((goal, idx) => {
                const li = document.createElement('li');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = goal.completed;
                
                checkbox.addEventListener('change', async () => {
                    goalsData[idx].completed = checkbox.checked;
                    goalsData[idx].updatedAt = new Date().toISOString();
                    await saveGoals();
                });
                
                li.appendChild(checkbox);
                const span = document.createElement('span');
                span.textContent = goal.text;
                if (goal.completed) {
                    span.style.textDecoration = 'line-through';
                    span.style.opacity = '0.6';
                }
                li.appendChild(span);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '√ó';
                deleteBtn.style.marginLeft = 'auto';
                deleteBtn.style.padding = '2px 8px';
                deleteBtn.style.fontSize = '16px';
                deleteBtn.style.background = '#ff4444';
                deleteBtn.onclick = async () => {
                    goalsData.splice(idx, 1);
                    await saveGoals();
                    renderGoals();
                };
                li.appendChild(deleteBtn);
                
                goalList.appendChild(li);
            });
        }

        goalsForm.addEventListener('submit', async e => {
            e.preventDefault();
            const newGoal = goalInput.value.trim();
            if (newGoal) {
                goalsData.push({
                    text: newGoal,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    id: Date.now().toString()
                });
                await saveGoals();
                goalInput.value = '';
                renderGoals();
            }
        });

        // --- Journal Management ---
        const journalForm = document.getElementById('journal-form');
        const journalText = document.getElementById('journal-text');
        const journalEntries = document.getElementById('journal-entries');
        let journalData = [];

        async function loadJournal() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('journal').doc(currentUser.uid).get();
                journalData = doc.exists ? doc.data().entries || [] : [];
                renderJournal();
            } catch (error) {
                console.error('Error loading journal:', error);
                journalData = JSON.parse(localStorage.getItem('studyJournal') || '[]');
                renderJournal();
            }
        }

        async function saveJournal() {
            if (!currentUser) return;
            
            if (isOnline) {
                try {
                    await db.collection('journal').doc(currentUser.uid).set({ 
                        entries: journalData,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving journal:', error);
                    localStorage.setItem('studyJournal', JSON.stringify(journalData));
                }
            } else {
                localStorage.setItem('studyJournal', JSON.stringify(journalData));
                localStorage.setItem('journalPendingSync', 'true');
            }
        }

        function renderJournal() {
            journalEntries.innerHTML = '';
            [...journalData].reverse().forEach((entry, idx) => {
                const li = document.createElement('li');
                li.style.padding = '8px 0';
                li.style.borderBottom = '1px solid #eee';
                li.style.fontSize = '0.95rem';
                
                const entryText = typeof entry === 'string' ? entry : 
                    `${new Date(entry.date).toLocaleDateString()}: ${entry.text}`;
                li.textContent = entryText;
                
                journalEntries.appendChild(li);
            });
        }

        journalForm.addEventListener('submit', async e => {
            e.preventDefault();
            const entry = journalText.value.trim();
            if (entry) {
                const newEntry = {
                    text: entry,
                    date: new Date().toISOString(),
                    id: Date.now().toString()
                };
                journalData.push(newEntry);
                await saveJournal();
                journalText.value = '';
                renderJournal();
            }
        });

        // --- Offline Data Sync ---
        async function syncOfflineData() {
            if (!currentUser || !isOnline) return;
            
            try {
                if (localStorage.getItem('goalsPendingSync')) {
                    const localGoals = JSON.parse(localStorage.getItem('studyGoals') || '[]');
                    if (localGoals.length > 0) {
                        await db.collection('goals').doc(currentUser.uid).set({ 
                            items: localGoals,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            syncedFromOffline: true
                        });
                        localStorage.removeItem('goalsPendingSync');
                    }
                }
                
                if (localStorage.getItem('journalPendingSync')) {
                    const localJournal = JSON.parse(localStorage.getItem('studyJournal') || '[]');
                    if (localJournal.length > 0) {
                        await db.collection('journal').doc(currentUser.uid).set({ 
                            entries: localJournal,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            syncedFromOffline: true
                        });
                        localStorage.removeItem('journalPendingSync');
                    }
                }
                
                console.log('Offline data synced successfully');
            } catch (error) {
                console.error('Error syncing offline data:', error);
            }
        }

        // --- Motivation Quotes ---
        const quotes = [
            "Success is the sum of small efforts, repeated day in and day out.",
            "Don't watch the clock; do what it does. Keep going.",
            "Believe in yourself and all that you are.",
            "Your limitation‚Äîit's only your imagination.",
            "Push yourself, because no one else is going to do it for you.",
            "Great things never come from comfort zones.",
            "Dream it. Wish it. Do it.",
            "Stay positive, work hard, make it happen.",
            "The secret of getting ahead is getting started.",
            "It's going to be hard, but hard does not mean impossible.",
            "The future belongs to those who believe in the beauty of their dreams.",
            "Education is the most powerful weapon which you can use to change the world.",
            "The only way to do great work is to love what you do.",
            "Success is not final, failure is not fatal; it is the courage to continue that counts.",
            "Your education is a dress rehearsal for a life that is yours to lead."
        ];

        const motivationQuote = document.getElementById('motivation-quote');
        const newQuoteBtn = document.getElementById('new-quote-btn');
        const quoteHistory = document.getElementById('quote-history');
        let usedQuotes = [];

        function displayRandomQuote() {
            if (usedQuotes.length === quotes.length) {
                usedQuotes = [];
                quoteHistory.innerHTML = '';
            }
            
            let index = Math.floor(Math.random() * quotes.length);
            while (usedQuotes.includes(index)) {
                index = Math.floor(Math.random() * quotes.length);
            }
            
            usedQuotes.push(index);
            motivationQuote.textContent = quotes[index];
            
            const li = document.createElement('li');
            li.textContent = quotes[index];
            li.style.padding = '5px 0';
            li.style.borderBottom = '1px solid #eee';
            li.style.fontSize = '0.9rem';
            li.style.fontStyle = 'italic';
            quoteHistory.insertBefore(li, quoteHistory.firstChild);
        }

        newQuoteBtn.addEventListener('click', displayRandomQuote);
        
        // Initialize with a quote
        displayRandomQuote();

        // Update header quote every 30 seconds
        setInterval(() => {
            const headerQuote = document.getElementById('quote');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            headerQuote.textContent = `"${randomQuote}"`;
        }, 30000);

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (!isOnline) {
                offlineNotice.style.display = 'block';
            }
        });
    </script>
</body>
</html>
